<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Monte Carlo Tau â€” Point Shooter</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#7c3aed;
      --ok:#34d399; --bad:#fb7185; --ink:#e6eef8;
    }
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(180deg,var(--bg),#071226);color:var(--ink);display:flex;align-items:center;justify-content:center;padding:24px;box-sizing:border-box}
    .app{width:100%;max-width:1100px;display:flex;gap:20px}
    .panel{background:linear-gradient(180deg,var(--card),#07121a);border-radius:12px;padding:16px;box-shadow:0 6px 24px rgba(2,6,23,0.6)}
    .left{flex:1;display:flex;flex-direction:column;gap:12px}
    .right{width:300px;display:flex;flex-direction:column;gap:12px}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted)}
    .title{display:flex;align-items:center;gap:12px}
    .hud{display:flex;gap:12px;flex-wrap:wrap}
    .stat{background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent);padding:8px 10px;border-radius:8px;min-width:120px}
    .big{font-size:22px;font-weight:700}
    .controls{display:flex;gap:8px;align-items:center;margin-top:auto}
    button{background:linear-gradient(180deg,#122433,#0a2a3d);color:var(--ink);border:1px solid rgba(255,255,255,0.05);padding:8px 12px;border-radius:8px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,var(--accent),#5b21b6);box-shadow:0 6px 18px rgba(124,58,237,0.18)}
    button:hover{opacity:.9}
    canvas{width:100%;height:calc(100vw * 0.6);max-height:720px;background:linear-gradient(180deg,#081019,#06101a);border-radius:8px;display:block}
    .legend{display:flex;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%}
    .fps{position:absolute;bottom:8px;right:12px;font-size:11px;color:rgba(255,255,255,0.32)}
    .canvasWrap{position:relative}
    @media (max-width:900px){.app{flex-direction:column}.right{width:100%}canvas{height:60vw}}
  </style>
</head>
<body>
  <div class="app">
    <div class="left panel">
      <div class="title">
        <h1>Monte Carlo Tau â€” Point Shooter</h1>
        <div style="margin-left:auto" class="muted">Click to drop points. 60s round.</div>
      </div>

      <div class="hud">
        <div class="stat">
          <div class="muted">Ï„ estimate</div>
          <div id="tau" class="big">-</div>
        </div>
        <div class="stat">
          <div class="muted">Score</div>
          <div id="score" class="big">0</div>
        </div>
        <div class="stat">
          <div class="muted">Inside / Total</div>
          <div id="counts" class="big">0 / 0</div>
        </div>
        <div class="stat">
          <div class="muted">Time</div>
          <div id="time" class="big">60.0s</div>
        </div>
      </div>

      <div class="canvasWrap">
        <canvas id="c"></canvas>
        <div id="fps" class="fps"></div>
      </div>

      <div class="legend">
        <span class="dot" style="background:linear-gradient(90deg,var(--ok),#16a34a)"></span>
        <span class="muted">inside</span>
        <span style="width:12px"></span>
        <span class="dot" style="background:linear-gradient(90deg,var(--bad),#ef4444)"></span>
        <span class="muted">outside</span>
      </div>

      <div class="controls">
        <button id="startBtn" class="primary">Start</button>
        <button id="resetBtn">Reset</button>
        <button id="saveBtn">Save Snapshot</button>
        <span class="muted" style="margin-left:auto">Tip: aim near the circle edge for risk/reward.</span>
      </div>
    </div>

    <div class="right panel">
      <div class="stat">
        <div class="muted">Rules</div>
        <ul class="muted" style="margin:8px 0 0 18px;line-height:1.4">
          <li>Click anywhere inside the square to drop a point.</li>
          <li><span style="color:var(--ok)">Inside</span>: +10 pts</li>
          <li><span style="color:var(--bad)">Outside</span>: âˆ’5 pts</li>
          <li>Round time: 60 seconds</li>
          <li>Ï„ â‰ˆ 8 Â· (inside / total)</li>
        </ul>
      </div>
      <div class="stat">
        <div class="muted">Notes</div>
        <p class="muted" style="margin:8px 0 0">
          This is a game, so points are <em>not random</em>; the Ï„ estimate reflects your shots (biased). ðŸ˜„
        </p>
      </div>
    </div>
  </div>

  <script>
    // ---------- Canvas & DPR ----------
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d', { alpha: false });
    const fpsEl = document.getElementById('fps');
    let DPR = 1;

    function resize() {
      DPR = Math.min(window.devicePixelRatio || 1, 2);
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * DPR);
      canvas.height = Math.floor(rect.height * DPR);
      ctx.setTransform(DPR,0,0,DPR,0,0); // draw in CSS px
      drawAll();
    }
    window.addEventListener('resize', resize);

    // ---------- Geometry helpers ----------
    // Square = [-1,1]^2; Circle: x^2 + y^2 <= 1
    function getCanvasRect() { return canvas.getBoundingClientRect(); }
    function centerAndScale() {
      const r = getCanvasRect(), w = r.width, h = r.height;
      const s = 0.5 * Math.min(w,h);
      const cx = 0.5 * w, cy = 0.5 * h;
      return {cx, cy, s, w, h};
    }
    function toCanvas(p) {
      const {cx, cy, s} = centerAndScale();
      const x = cx + p[0] * s;
      const y = cy - p[1] * s;
      return [x,y];
    }
    function fromCanvas(x,y) {
      const {cx, cy, s} = centerAndScale();
      return [(x - cx)/s, -(y - cy)/s]; // normalized to [-1,1]
    }

    // ---------- Game state ----------
    const tauEl = document.getElementById('tau');
    const scoreEl = document.getElementById('score');
    const countsEl = document.getElementById('counts');
    const timeEl = document.getElementById('time');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const saveBtn = document.getElementById('saveBtn');

    let running = false;
    let timeLeft = 60.0; // seconds
    let lastTS = 0;
    let total = 0, inside = 0, score = 0;

    // particles for click feedback
    const shots = []; // {x,y,inside,life}

    // ---------- Sounds (tiny beeps) ----------
    const ACtx = (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext || window.webkitAudioContext)() : null;
    function beep(freq=440, dur=0.05, gain=0.03) {
      if(!ACtx) return;
      const t0 = ACtx.currentTime;
      const osc = ACtx.createOscillator();
      const g = ACtx.createGain();
      osc.frequency.value = freq;
      g.gain.value = gain;
      osc.connect(g).connect(ACtx.destination);
      osc.start(t0);
      osc.stop(t0 + dur);
    }

    // ---------- Drawing ----------
    function drawBackground() {
      const r = getCanvasRect();
      ctx.fillStyle = '#06101a';
      ctx.fillRect(0,0,r.width,r.height);
    }
    function drawBoard() {
      const {cx, cy, s, w, h} = centerAndScale();

      // square border
      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.lineWidth = 2;
      ctx.strokeRect(cx - s, cy - s, 2*s, 2*s);

      // circle
      ctx.beginPath();
      ctx.arc(cx, cy, s, 0, Math.PI*2);
      const grad = ctx.createRadialGradient(cx,cy,s*0.1, cx,cy,s);
      grad.addColorStop(0,'rgba(124,58,237,0.06)');
      grad.addColorStop(1,'rgba(2,6,23,0)');
      ctx.fillStyle = grad; ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.18)';
      ctx.lineWidth = 1.5; ctx.stroke();

      // axes (light)
      ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(cx - s, cy); ctx.lineTo(cx + s, cy); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(cx, cy - s); ctx.lineTo(cx, cy + s); ctx.stroke();
    }
    function drawShots(dt) {
      // update & render simple fading squares
      for (let i = shots.length - 1; i >= 0; i--) {
        const p = shots[i];
        p.life -= dt;
        if (p.life <= 0) { shots.splice(i,1); continue; }
        ctx.globalAlpha = Math.max(0, p.life);
        ctx.fillStyle = p.inside ? '#34d399' : '#fb7185';
        ctx.fillRect(p.x - 2, p.y - 2, 4, 4);
        ctx.globalAlpha = 1;
      }
    }

    function drawAll() {
      drawBackground();
      drawBoard();
      drawShots(0); // just render current
    }

    // ---------- HUD ----------
    function updateHUD() {
      const tau = total > 0 ? 8 * (inside / total) : NaN;
      tauEl.textContent = isNaN(tau) ? '-' : tau.toFixed(6);
      scoreEl.textContent = score.toString();
      countsEl.textContent = `${inside} / ${total}`;
      timeEl.textContent = `${timeLeft.toFixed(1)}s`;
    }

    // ---------- Interaction ----------
    canvas.addEventListener('click', (e) => {
      if (!running) return;
      const rect = getCanvasRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // check within square bounds; ignore clicks outside the square
      const {cx, cy, s} = centerAndScale();
      if (x < cx - s || x > cx + s || y < cy - s || y > cy + s) return;

      const [nx, ny] = fromCanvas(x, y);
      const hit = (nx*nx + ny*ny) <= 1.0;

      total += 1;
      if (hit) { inside += 1; score += 10; beep(660, 0.04, 0.04); }
      else     { score -= 5;  beep(200, 0.05, 0.035); }

      shots.push({ x, y, inside: hit, life: 1.0 });
      updateHUD();
    });

    // ---------- Game loop ----------
    let rafId = null;
    let fpsFrames = 0, fpsLast = performance.now();

    function loop(ts) {
      if (!lastTS) lastTS = ts;
      const dt = Math.min(0.05, (ts - lastTS)/1000); // clamp
      lastTS = ts;

      // time & end condition
      if (running) {
        timeLeft = Math.max(0, timeLeft - dt);
        if (timeLeft <= 0) {
          running = false;
        }
      }

      // draw
      drawBackground();
      drawBoard();
      drawShots(dt);
      updateHUD();

      // FPS meter
      fpsFrames++;
      const now = ts;
      if (now - fpsLast >= 1000) {
        const fps = Math.round((fpsFrames * 1000) / (now - fpsLast));
        fpsEl.textContent = `${fps} FPS`;
        fpsFrames = 0; fpsLast = now;
      }

      rafId = requestAnimationFrame(loop);
    }

    // ---------- Controls ----------
    startBtn.addEventListener('click', async () => {
      if (ACtx && ACtx.state === 'suspended') { try { await ACtx.resume(); } catch{} }
      if (!running && timeLeft <= 0) { // restart after end
        timeLeft = 60.0; total = inside = score = 0; shots.length = 0;
      }
      running = true;
    });

    resetBtn.addEventListener('click', () => {
      running = false;
      timeLeft = 60.0; total = inside = score = 0; shots.length = 0;
      drawAll(); updateHUD();
    });

    // Save PNG snapshot (hi-res)
    saveBtn.addEventListener('click', () => {
      const rect = getCanvasRect();
      const out = document.createElement('canvas');
      out.width = Math.floor(rect.width * DPR);
      out.height = Math.floor(rect.height * DPR);
      const octx = out.getContext('2d');
      octx.setTransform(DPR,0,0,DPR,0,0);
      // redraw current board & shots into offscreen
      // (cheaper: draw the on-screen canvas)
      octx.drawImage(canvas, 0, 0, rect.width, rect.height);
      octx.font = '16px system-ui,Segoe UI,Roboto,Arial';
      octx.fillStyle = 'rgba(255,255,255,0.9)';
      const tauText = document.getElementById('tau').textContent;
      octx.fillText(`Ï„ â‰ˆ ${tauText} (inside/total = ${inside}/${total}, score=${score})`, 16, 28);
      const a = document.createElement('a');
      a.href = out.toDataURL('image/png'); a.download = `point-shooter-${Date.now()}.png`; a.click();
    });

    // ---------- Init ----------
    resize();
    updateHUD();
    drawAll();
    rafId = requestAnimationFrame(loop);
  </script>
</body>
</html>
